# ═══════════════════════════════════════════════════════════════════════════════
# Redis Production Configuration — Task Queue Persistence
# ═══════════════════════════════════════════════════════════════════════════════
#
# This config ensures zero data loss for the task queue by combining:
#   1. AOF (Append Only File) — real-time write log
#   2. RDB snapshots — periodic full dump for fast recovery
#
# NOTE: Railway's managed Redis has AOF enabled by default. This file serves
#       as documentation and can be applied directly if self-hosting Redis.
# ═══════════════════════════════════════════════════════════════════════════════

# ── AOF Persistence ───────────────────────────────────────────────────────────
# Logs every write operation. On restart, Redis replays the log to restore state.
appendonly yes

# Sync strategy:
#   - always:    fsync after every write (safest, slowest — ~100x overhead)
#   - everysec:  fsync once per second  (1-second loss window, fast)
#   - no:        OS decides when to flush (fastest, risky)
appendfsync everysec

# Rewrite the AOF when it doubles in size (compacts old entries)
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ── RDB Snapshots (secondary backup) ─────────────────────────────────────────
# Format: save <seconds> <min-changes>
# Snapshot every 60s if ≥1000 keys changed, every 300s if ≥10 keys changed.
save 300 10
save 60 1000

# Compress RDB with LZF (small CPU cost, big space savings)
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# ── Memory Management ────────────────────────────────────────────────────────
# Cap memory at 256MB (suitable for task queue + rate limit metadata).
# LRU eviction ensures rate limit keys are evicted before queue keys.
maxmemory 256mb
maxmemory-policy allkeys-lru

# ── Connection Limits ─────────────────────────────────────────────────────────
maxclients 100
timeout 300
tcp-keepalive 60

# ── Logging ───────────────────────────────────────────────────────────────────
loglevel notice
